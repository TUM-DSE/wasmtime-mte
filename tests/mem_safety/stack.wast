(module
  (memory 1 1)
  (global $sp (mut i32) (i32.const 64))
  (func (export "foo") (result i32)
        (i32.sub (global.get $sp) (i32.const 16))
        (i32.const 16)
        (segment.stack_new)
        (i32.const 42)
        (i32.store)
        (i32.sub (i32.const 64) (i32.const 16))
        (i32.load)

        (i32.sub (global.get $sp) (i32.const 16))
        (global.get $sp)
        (i32.const 16)
        (segment.stack_free)
        (return)
  )
;;  (func (export "foo2") (result i32)
;;        (i32.sub (i32.const 64) (i32.const 16))
;;        (i32.const 42)
;;        (i32.store)
;;        (i32.sub (i32.const 64) (i32.const 16))
;;        (i32.load)
;;        (return)
;;  )
)

;;(assert_return (invoke "foo") (i32.const 42))

